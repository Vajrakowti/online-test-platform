<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Test</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #f8f9fc;
            --accent-color: #36b9cc;
            --success-color: #1cc88a;
            --danger-color: #e74a3b;
            --warning-color: #f6c23e;
            --info-color: #36b9cc;
            --text-color: #5a5c69;
            --border-color: #e3e6f0;
            --light-grey: #f0f2f5;
        }

        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            background-color: var(--secondary-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-bar {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .top-bar h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .timer-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2em;
            color: var(--text-color);
        }

        .negative-marking-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1em;
            color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
            padding: 8px 12px;
            border-radius: 4px;
        }

        .negative-marking-info i {
            color: #e74c3c;
        }

        .quiz-wrapper {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
        }

        .main-quiz-content {
            flex: 3;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .question-panel-sidebar {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.08);
            padding: 20px;
            min-width: 280px;
        }

        .question-panel-header {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .status-legend {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .status-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            color: white;
        }

        /* Updated Status Colors */
        .status-0 { background-color: white; color: var(--text-color); border: 1px solid var(--border-color); } /* Not Visited */
        .status-1 { background-color: #1cc88a; color: white; } /* Answered */
        .status-2 { background-color: #f6c23e; color: white; } /* Marked for Review */
        .status-3 { background-color: #e74a3b; color: white; } /* Not Answered */
        .status-4 { background-color: #36b9cc; color: white; } /* Answered and Marked for Review */
        
        .question-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 10px;
        }

        .question-grid-item {
            border-radius: 4px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .question-grid-item:hover {
            background-color: var(--primary-color);
            color: white;
        }
        .question-grid-item.current {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Section Navigation Styles */
        .section-nav {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-nav-btn {
            background-color: var(--info-color); /* A distinct color for section buttons */
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .section-nav-btn:hover {
            background-color: #2c9faf;
        }

        .current-section-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .question-container {
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
        }
        
        .question {
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .question-number {
            font-weight: bold;
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            color: var(--text-color);
        }
        
        .option:hover {
            background-color: var(--light-grey);
            border-color: var(--primary-color);
        }
        
        .option input[type="radio"] {
            margin: 0;
            transform: scale(1.2);
            cursor: pointer;
        }
        
        .option label {
            flex: 1;
            cursor: pointer;
        }
        
        .quiz-navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            gap: 15px;
            flex-wrap: wrap;
        }

        .quiz-navigation-buttons button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.2s;
            flex: 1;
            min-width: 150px;
        }

        .btn-prev {
            background-color: var(--info-color);
            color: white;
        }
        .btn-prev:hover {
            background-color: #2c9faf;
            transform: translateY(-2px);
        }

        .btn-clear {
            background-color: var(--warning-color);
            color: var(--text-color);
        }
        .btn-clear:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }

        .btn-save-next {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-save-next:hover {
            background-color: #3756a4;
            transform: translateY(-2px);
        }

        .btn-submit-test {
            background-color: var(--success-color);
            color: white;
        }
        .btn-submit-test:hover {
            background-color: #17a673;
            transform: translateY(-2px);
        }

        /* Add new button styles */
        .btn-mark-review {
            background-color: var(--warning-color);
            color: white;
        }
        .btn-mark-review:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }

        .btn-answered-review {
            background-color: var(--info-color);
            color: white;
        }
        .btn-answered-review:hover {
            background-color: #2c9faf;
            transform: translateY(-2px);
        }
        
        /* Responsive adjustments */
        @media (max-width: 992px) {
            .quiz-wrapper {
                flex-direction: column;
                padding: 15px;
            }
            .question-panel-sidebar {
                min-width: unset;
                width: 100%;
            }
        }

        @media (max-width: 576px) {
            .top-bar {
                flex-direction: column;
                gap: 10px;
            }
            .quiz-navigation-buttons button {
                flex: none;
                width: 100%;
            }
            .main-quiz-content, .question-panel-sidebar {
                padding: 20px;
            }
        }

        /* Full screen mode styles */
        body.fullscreen-mode {
            overflow: hidden;
        }

        body.fullscreen-mode .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: var(--bg-color);
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        body.fullscreen-mode .quiz-wrapper {
            margin-top: 80px;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        body.fullscreen-mode .main-quiz-content {
            max-width: 100%;
            padding: 20px;
        }

        /* Prevent exiting fullscreen */
        body.fullscreen-mode::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.1);
            z-index: -1;
        }

        /* Disable right-click and other browser controls */
        body.fullscreen-mode {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body.fullscreen-mode * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Allow text selection in question text and options */
        body.fullscreen-mode .question-text,
        body.fullscreen-mode .option label {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        /* Add these new styles after the existing styles */
        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }

        .fullscreen-warning {
            background-color: #2c3e50;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid #e74a3b;
        }

        .fullscreen-warning h2 {
            color: #f1edec;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .fullscreen-warning p {
            color: #f6f2f2;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .start-button {
            background-color: #e74a3b;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .start-button:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .warning-count {
            background-color: #e74a3b;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin: 10px 0;
        }

        .devtools-warning {
            background-color: #e74a3b;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            display: none;
        }

        #startFullscreenBtn {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 20px auto;
            display: block;
        }

        #startFullscreenBtn:hover {
            background-color: #3756a4;
        }

        /* Add these styles in the style section */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .modal-button {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .modal-button.yes {
            background-color: var(--success-color);
            color: white;
        }

        .modal-button.no {
            background-color: var(--danger-color);
            color: white;
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Add styles for review buttons container */
        .review-buttons-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background-color: var(--light-grey);
            border-radius: 6px;
        }

        .review-buttons-container button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        /* Add toast message styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            background-color: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 250px;
            max-width: 350px;
            animation: slideIn 0.3s ease-in-out;
        }

        .toast.error {
            background-color: #e74a3b;
        }

        .toast.success {
            background-color: #1cc88a;
        }

        .toast.warning {
            background-color: #f6c23e;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast.hide {
            animation: slideOut 0.3s ease-in-out forwards;
        }
    </style>
</head>
<body>
    <!-- Add toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <div id="fullscreenOverlay" class="fullscreen-overlay">
        <div class="fullscreen-warning" style="background-color: #f30a0a;">
            <h2>Warning!</h2>
            <p>This quiz must be taken in fullscreen mode.</p>
            <p>Please click the button below to continue.</p>
            <button id="startFullscreenBtn" class="start-button">Enter Fullscreen Mode</button>
        </div>
    </div>

    <div id="exitFullscreenWarning" class="fullscreen-overlay" style="display: none;">
        <div class="fullscreen-warning">
            <h2>Warning!</h2>
            <p>You have exited fullscreen mode or switched tabs.</p>
            <p>Please return to fullscreen to continue the quiz.</p>
            <div class="warning-count">Warning <span id="warningCount">1</span> of 2</div>
            <button onclick="enterFullscreen()" class="start-button">Return to Fullscreen</button>
        </div>
    </div>

    <div id="devtoolsWarning" class="devtools-warning">
        <h2>Warning!</h2>
        <p>Developer tools are not allowed during the quiz. The quiz will be submitted automatically.</p>
    </div>

    <div class="top-bar" style="display: none;">
        <h1 id="quizNameHeader">Quiz</h1>
        <div class="timer-container">
            <i class="far fa-clock"></i>
            <span id="timer">00:00:00</span>
        </div>
        <div class="negative-marking-info" id="negativeMarkingInfo" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <span>Negative Marking: <span id="negativeMarkingValue">0</span></span>
        </div>
    </div>

    <div class="quiz-wrapper" style="display: none;">
        <div class="main-quiz-content">
            <div id="sectionNavigation" class="section-nav">
                <!-- Section navigation (buttons) will be dynamically added here -->
            </div>
            <h2 id="currentSectionTitle" class="current-section-title"></h2>

            <div class="review-buttons-container">
                <button class="btn-mark-review" id="markReviewBtn">Mark for Review</button>
                <button class="btn-answered-review" id="answeredReviewBtn">Answered & Mark for Review</button>
            </div>

            <div id="questionsContainer">
                <!-- Questions will be dynamically loaded here, one at a time -->
            </div>

            <div class="quiz-navigation-buttons">
                <button class="btn-prev" id="prevQuestionBtn" style="display: none;"><i class="fas fa-chevron-left"></i> Previous</button>
                <button class="btn-clear" id="clearResponseBtn">Clear Response</button>
                <button class="btn-save-next" id="saveNextBtn">Save & Next <i class="fas fa-chevron-right"></i></button>
                <button class="btn-submit-test" id="submitQuizBtn">Submit Test</button>
            </div>
        </div>

        <div class="question-panel-sidebar">
            <h3 class="question-panel-header">Question Panel</h3>
            <div class="status-legend">
                <div class="status-item"><span class="status-box status-3">0</span> Not Answered</div>
                <div class="status-item"><span class="status-box status-1">0</span> Answered</div>
                <div class="status-item"><span class="status-box status-2">0</span> Marked for Review</div>
                <div class="status-item"><span class="status-box status-0">0</span> Not Visited</div>
                <div class="status-item"><span class="status-box status-4">0</span> Answered and Marked for Review</div>
            </div>
            <div class="question-grid" id="questionGrid">
                <!-- Question numbers will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <div id="submitModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Submit Quiz</h2>
            <p>Are you sure you want to submit the quiz?</p>
            <div class="modal-buttons">
                <button class="modal-button yes" id="confirmSubmit">Yes, Submit</button>
                <button class="modal-button no" id="cancelSubmit">No, Continue</button>
            </div>
        </div>
    </div>

    <script>
        let quizDataGlobal = null;
        let allQuestionsFlat = []; // Stores all questions with global index and section info
        let currentQuestionIndex = 0; // Global index of the currently displayed question
        let answers = []; // Stores student's answers {questionIndex: globalIdx, answer: "optionValue"}

        // questionStatuses:
        // 0: Not Visited (Initial state, light-grey)
        // 1: Answered (Green)
        // 2: Marked for Review (Yellow)
        // 3: Not Answered (Red, when visited but no answer)
        // 4: Answered & Marked for Review (Blue/Info)
        let questionStatuses = []; 

        // Add these new variables at the top of your script
        let fullscreenWarnings = 0;
        let isFullscreen = false;

        // Add these variables at the top of your script
        let lastActiveTime = Date.now();
        let tabSwitchCount = 0;
        let isQuizSubmitted = false;
        let timerInterval = null;

        // Function to display the quiz content (questions, sections, options)
        function displayQuizContent() {
            if (!quizDataGlobal || !quizDataGlobal.sections) {
                console.error("Quiz data not loaded or invalid.");
                return;
            }

            document.getElementById('quizNameHeader').textContent = quizDataGlobal.quizName;
            updateTimer(quizDataGlobal.duration);

            // Flatten all questions and store their section context
            allQuestionsFlat = [];
            let globalIdxCounter = 0;
            quizDataGlobal.sections.forEach((section, sectionIdx) => {
                section.questions.forEach((question, qIdx) => {
                    allQuestionsFlat.push({
                        question: question.question,
                        options: question.options,
                        correctAnswers: question.correctAnswers,
                        sectionName: section.name,
                        globalIndex: globalIdxCounter,
                        sectionIndex: sectionIdx,
                        questionIndexInSection: qIdx
                    });
                    globalIdxCounter++;
                });
            });

            const questionsContainer = document.getElementById('questionsContainer');
            questionsContainer.innerHTML = ''; // Clear existing content

            // Populate question statuses initially (all not visited, status 0)
            questionStatuses = Array(allQuestionsFlat.length).fill(0); 
            answers = Array(allQuestionsFlat.length).fill(null); // Initialize answers array with null

            // Render all questions, but initially hide all except the first one
            allQuestionsFlat.forEach((q, globalIdx) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-container';
                questionDiv.id = `q-${globalIdx}`;
                questionDiv.style.display = 'none'; // Initially hide all questions

                questionDiv.innerHTML = `
                    <div class="question">
                        <span class="question-number">${globalIdx + 1}.</span>
                        <span class="question-text">${q.question}</span>
                    </div>
                    <div class="options">
                        ${q.options.map((option, oIdx) => `
                            <div class="option">
                                <input type="radio" 
                                       name="question_${globalIdx}" 
                                       id="q${globalIdx}_o${oIdx}" 
                                       value="${option}">
                                <label for="q${globalIdx}_o${oIdx}">${option}</label>
                            </div>
                        `).join('')}
                    </div>
                `;
                questionsContainer.appendChild(questionDiv);
            });

            renderSectionNavigation(); // Render section navigation buttons
            renderQuestionPanel(); // Render/update question panel with numbers
            showQuestion(currentQuestionIndex); // Show the first question
        }

        // New function to render section navigation (buttons)
        function renderSectionNavigation() {
            const sectionNavContainer = document.getElementById('sectionNavigation');
            sectionNavContainer.innerHTML = ''; // Clear existing
            
            // Use a Set to get unique section names while preserving order from quizDataGlobal.sections
            const uniqueSectionNames = [];
            const seenSectionNames = new Set();
            quizDataGlobal.sections.forEach(section => {
                if (!seenSectionNames.has(section.name)) {
                    uniqueSectionNames.push(section.name);
                    seenSectionNames.add(section.name);
                }
            });

            uniqueSectionNames.forEach(sectionName => {
                // Find the global index of the first question for this section
                const firstQuestionGlobalIndex = allQuestionsFlat.findIndex(q => q.sectionName === sectionName);
                if (firstQuestionGlobalIndex !== -1) {
                    const sectionBtn = document.createElement('button');
                    sectionBtn.className = 'section-nav-btn'; 
                    sectionBtn.textContent = sectionName;
                    sectionBtn.onclick = () => showQuestion(firstQuestionGlobalIndex);
                    sectionNavContainer.appendChild(sectionBtn);
                }
            });
        }

        // Function to display a specific question by its global index
        function showQuestion(index) {
            if (index >= 0 && index < allQuestionsFlat.length) {
                // Hide currently visible question
                const prevQuestionDiv = document.getElementById(`q-${currentQuestionIndex}`);
                if (prevQuestionDiv) {
                    prevQuestionDiv.style.display = 'none';
                }

                currentQuestionIndex = index;

                // Show the new current question
                const currentQuestionDiv = document.getElementById(`q-${currentQuestionIndex}`);
                if (currentQuestionDiv) {
                    currentQuestionDiv.style.display = 'block';
                }

                // Update section title header
                const currentSectionName = allQuestionsFlat[currentQuestionIndex].sectionName;
                document.getElementById('currentSectionTitle').textContent = currentSectionName;

                // Mark current question as 'Not Answered' if it was 'Not Visited'
                if (questionStatuses[currentQuestionIndex] === 0) { // If Not Visited
                    questionStatuses[currentQuestionIndex] = 3; // Change to Not Answered
                }

                // Re-check selected radio button if an answer exists for this question
                const savedAnswer = answers[currentQuestionIndex];
                if (savedAnswer) {
                    const selectedRadio = document.querySelector(`input[name="question_${currentQuestionIndex}"][value="${savedAnswer.answer}"]`);
                    if (selectedRadio) {
                        selectedRadio.checked = true;
                    }
                } else {
                    // If no saved answer, ensure no radio button is checked
                    const currentQuestionRadios = document.querySelectorAll(`input[name="question_${currentQuestionIndex}"]`);
                    currentQuestionRadios.forEach(radio => radio.checked = false);
                }

                // Setup radio button listeners for the current question
                setupRadioButtonListeners();

                // Update navigation buttons visibility
                document.getElementById('prevQuestionBtn').style.display = currentQuestionIndex === 0 ? 'none' : 'block';
                document.getElementById('saveNextBtn').style.display = currentQuestionIndex === allQuestionsFlat.length - 1 ? 'none' : 'block';

                // Update question panel to reflect current status
                renderQuestionPanel();
            } else {
                // Handle navigation boundaries
                if (index < 0) {
                    showToast("This is the first question.", "warning");
                } else if (index >= allQuestionsFlat.length) {
                    showToast("This is the last question. Click Submit Test to finish.", "warning");
                }
            }
        }

        // Timer function (placeholder, assumes actual timer logic is handled)
        function updateTimer(durationInSeconds) {
            let timerSpan = document.getElementById('timer');
            let totalSeconds = durationInSeconds;

            function formatTime(seconds) {
                const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
                const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
                const s = String(seconds % 60).padStart(2, '0');
                return `${h}:${m}:${s}`;
            }

            // Initial display
            timerSpan.textContent = formatTime(totalSeconds);

            // Clear any existing timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(() => {
                totalSeconds--;
                if (totalSeconds < 0) {
                    clearInterval(timerInterval);
                    timerSpan.textContent = "00:00:00";
                    if (!isQuizSubmitted) {
                        alert("Time's up! Your quiz will be submitted automatically.");
                        submitQuiz();
                    }
                } else {
                    timerSpan.textContent = formatTime(totalSeconds);
                }
            }, 1000);
        }

        function nextQuestion() {
            saveAnswer(); // Save current answer before moving
            if (currentQuestionIndex < allQuestionsFlat.length - 1) {
                showQuestion(currentQuestionIndex + 1);
            } else {
                showToast("You are at the last question.", "warning");
            }
        }

        function prevQuestion() {
            saveAnswer(); // Save current answer before moving
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
            } else {
                showToast("You are at the first question.", "warning");
            }
        }

        // Modified saveAnswer to correctly update statuses
        function saveAnswer() {
            const selectedOption = document.querySelector(`input[name="question_${currentQuestionIndex}"]:checked`);
            if (selectedOption) {
                answers[currentQuestionIndex] = {
                    questionIndex: currentQuestionIndex,
                    answer: selectedOption.value
                };
                // If the question was Not Visited (0) or Not Answered (3), change to Answered (1)
                if (questionStatuses[currentQuestionIndex] === 0 || questionStatuses[currentQuestionIndex] === 3) {
                    questionStatuses[currentQuestionIndex] = 1;
                }
                // If it was Marked for Review (2), now it's Answered & Marked for Review (4)
                if (questionStatuses[currentQuestionIndex] === 2) {
                    questionStatuses[currentQuestionIndex] = 4;
                }
            } else {
                // If no option selected (e.g., cleared response)
                answers[currentQuestionIndex] = null;
                // If it was Answered (1) or Answered & Marked for Review (4), change to Not Answered (3)
                if (questionStatuses[currentQuestionIndex] === 1 || questionStatuses[currentQuestionIndex] === 4) {
                    questionStatuses[currentQuestionIndex] = 3;
                }
                // If it was Marked for Review (2), keep it as Marked for Review (2)
                // If it was Not Visited (0), keep it as Not Visited (0)
            }
            renderQuestionPanel(); // Update question panel status
        }

        // Add event listeners for radio buttons to update status immediately
        function setupRadioButtonListeners() {
            const currentQuestionRadios = document.querySelectorAll(`input[name="question_${currentQuestionIndex}"]`);
            currentQuestionRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        answers[currentQuestionIndex] = {
                            questionIndex: currentQuestionIndex,
                            answer: this.value
                        };
                        // Update status to Answered (1) if it was Not Visited (0) or Not Answered (3)
                        if (questionStatuses[currentQuestionIndex] === 0 || questionStatuses[currentQuestionIndex] === 3) {
                            questionStatuses[currentQuestionIndex] = 1;
                        }
                        // If it was Marked for Review (2), now it's Answered & Marked for Review (4)
                        if (questionStatuses[currentQuestionIndex] === 2) {
                            questionStatuses[currentQuestionIndex] = 4;
                        }
                        renderQuestionPanel();
                    }
                });
            });
        }

        function clearResponse() {
            const currentQuestionRadios = document.querySelectorAll(`input[name="question_${currentQuestionIndex}"]`);
            currentQuestionRadios.forEach(radio => radio.checked = false);
            answers[currentQuestionIndex] = null;
            questionStatuses[currentQuestionIndex] = 3; // Mark as Not Answered
            renderQuestionPanel();
        }

        // Function to show submit confirmation modal
        function showSubmitModal() {
            document.getElementById('submitModal').style.display = 'flex';
        }

        // Function to hide submit confirmation modal
        function hideSubmitModal() {
            document.getElementById('submitModal').style.display = 'none';
        }

        // Add event listeners for modal buttons
        document.getElementById('confirmSubmit').addEventListener('click', function() {
            hideSubmitModal();
            submitQuiz();
        });

        document.getElementById('cancelSubmit').addEventListener('click', function() {
            hideSubmitModal();
        });

        // Modify the submit button click handler
        document.getElementById('submitQuizBtn').addEventListener('click', function() {
            showSubmitModal();
        });

        function submitQuiz() {
            if (isQuizSubmitted) return; // Prevent multiple submissions
            isQuizSubmitted = true;
            
            // Clear the timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            saveAnswer();
            const finalAnswers = answers.map((answer, index) => {
                if (answer !== null) {
                    return { questionIndex: index, answer: answer.answer };
                }
                return null;
            }).filter(Boolean);

            fetch('/student/startquiz/submit-quiz', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    quizName: quizDataGlobal.quizName,
                    answers: finalAnswers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Store in sessionStorage that quiz is completed
                    sessionStorage.setItem(`quiz_completed_${quizDataGlobal.quizName}`, 'true');
                    // Redirect to completion page
                    window.location.href = `/student/quiz-completion/${encodeURIComponent(quizDataGlobal.quizName)}`;
                } else {
                    alert('Quiz submission failed: ' + data.message);
                    isQuizSubmitted = false; // Reset submission flag if failed
                }
            })
            .catch(error => {
                console.error('Error submitting quiz:', error);
                alert('Error submitting quiz. Please try again.');
                isQuizSubmitted = false; // Reset submission flag if failed
            });
        }

        // Render Question Panel
        function renderQuestionPanel() {
            const questionGrid = document.getElementById('questionGrid');
            questionGrid.innerHTML = '';
            questionStatuses.forEach((status, index) => {
                const item = document.createElement('div');
                item.className = `question-grid-item status-${status} ${index === currentQuestionIndex ? 'current' : ''}`;
                item.textContent = index + 1;
                item.onclick = () => showQuestion(index);
                questionGrid.appendChild(item);
            });
            updateStatusCounts();
        }

        function updateStatusCounts() {
            const counts = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 }; // Initialize counts for all statuses
            questionStatuses.forEach(status => {
                counts[status]++;
            });

            document.querySelector('.status-0').textContent = counts[0]; // Not Visited
            document.querySelector('.status-1').textContent = counts[1]; // Answered
            document.querySelector('.status-2').textContent = counts[2]; // Marked for Review
            document.querySelector('.status-3').textContent = counts[3]; // Not Answered
            document.querySelector('.status-4').textContent = counts[4]; // Answered and Marked for Review
        }

        // Event Listeners for navigation buttons
        document.getElementById('prevQuestionBtn').addEventListener('click', prevQuestion);
        document.getElementById('saveNextBtn').addEventListener('click', nextQuestion);
        document.getElementById('clearResponseBtn').addEventListener('click', clearResponse);
        document.getElementById('submitQuizBtn').addEventListener('click', function() {
            showSubmitModal();
        });

        // Add event listeners for the new review buttons
        document.getElementById('markReviewBtn').addEventListener('click', function() {
            const selectedOption = document.querySelector(`input[name="question_${currentQuestionIndex}"]:checked`);
            if (selectedOption) {
                // If answered, mark as Answered & Marked for Review (4)
                questionStatuses[currentQuestionIndex] = 4;
            } else {
                // If not answered, mark as Marked for Review (2)
                questionStatuses[currentQuestionIndex] = 2;
            }
            renderQuestionPanel();
        });

        document.getElementById('answeredReviewBtn').addEventListener('click', function() {
            const selectedOption = document.querySelector(`input[name="question_${currentQuestionIndex}"]:checked`);
            if (selectedOption) {
                // Only mark as Answered & Marked for Review (4) if there's an answer
                questionStatuses[currentQuestionIndex] = 4;
                renderQuestionPanel();
            } else {
                showToast("Please select an answer before marking for review.");
            }
        });

        // Function to enter fullscreen mode
        async function enterFullscreen() {
            const element = document.documentElement;
            try {
                if (element.requestFullscreen) {
                    await element.requestFullscreen();
                } else if (element.webkitRequestFullscreen) {
                    await element.webkitRequestFullscreen();
                } else if (element.mozRequestFullScreen) {
                    await element.mozRequestFullScreen();
                } else if (element.msRequestFullscreen) {
                    await element.msRequestFullscreen();
                }
                isFullscreen = true;
                // Hide all overlays and show the quiz content
                document.getElementById('fullscreenOverlay').style.display = 'none';
                document.getElementById('exitFullscreenWarning').style.display = 'none';
                document.querySelector('.top-bar').style.display = 'flex';
                document.querySelector('.quiz-wrapper').style.display = 'flex';
            } catch (error) {
                console.error('Error entering fullscreen:', error);
                alert('Please allow fullscreen mode to continue with the quiz.');
            }
        }

        // Handle fullscreen changes
        function handleFullscreenChange() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement && 
                !document.mozFullScreenElement && !document.msFullscreenElement) {
                if (isFullscreen) {
                    fullscreenWarnings++;
                    if (fullscreenWarnings >= 3) {
                        submitQuiz();
                    } else {
                        document.getElementById('warningCount').textContent = fullscreenWarnings;
                        document.getElementById('exitFullscreenWarning').style.display = 'flex';
                        document.querySelector('.top-bar').style.display = 'none';
                        document.querySelector('.quiz-wrapper').style.display = 'none';
                    }
                }
            } else {
                isFullscreen = true;
                document.getElementById('fullscreenOverlay').style.display = 'none';
                document.getElementById('exitFullscreenWarning').style.display = 'none';
                document.querySelector('.top-bar').style.display = 'flex';
                document.querySelector('.quiz-wrapper').style.display = 'flex';
            }
        }

        // Add event listeners for fullscreen changes
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        // Add event listener for the fullscreen button
        document.getElementById('startFullscreenBtn').addEventListener('click', enterFullscreen);

        // Developer Tools Detection
        let devtools = function() {};
        devtools.toString = function() {
            document.getElementById('devtoolsWarning').style.display = 'flex';
            setTimeout(() => {
                submitQuiz();
            }, 2000);
            return '';
        }

        // Block right-click
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // Block keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (
                (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || // Ctrl+Shift+I or Ctrl+Shift+J
                (e.ctrlKey && e.keyCode === 85) || // Ctrl+U
                (e.keyCode === 123) // F12
            ) {
                e.preventDefault();
                return false;
            }
        });

        // Add this function to detect tab switching
        function handleVisibilityChange() {
            if (document.hidden) {
                if (isFullscreen) {
                    tabSwitchCount++;
                    if (tabSwitchCount >= 3) {
                        submitQuiz();
                    } else {
                        document.getElementById('warningCount').textContent = tabSwitchCount;
                        document.getElementById('exitFullscreenWarning').style.display = 'flex';
                        document.querySelector('.top-bar').style.display = 'none';
                        document.querySelector('.quiz-wrapper').style.display = 'none';
                    }
                }
            } else {
                lastActiveTime = Date.now();
            }
        }

        // Add visibility change event listener
        document.addEventListener('visibilitychange', handleVisibilityChange);

        // Modify the DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            const pathParts = window.location.pathname.split('/');
            const quizName = pathParts[pathParts.length - 1];

            // Check if quiz is already completed
            if (sessionStorage.getItem(`quiz_completed_${quizName}`) === 'true') {
                window.location.replace('/student');
                return;
            }

            // Prevent going back to quiz-start page
            window.history.pushState(null, '', window.location.href);
            window.onpopstate = function() {
                window.history.pushState(null, '', window.location.href);
                // Force redirect to dashboard if user tries to go back
                window.location.replace('/student');
            };

            // Show the fullscreen overlay initially
            document.getElementById('fullscreenOverlay').style.display = 'flex';
            document.getElementById('exitFullscreenWarning').style.display = 'none';
            document.querySelector('.top-bar').style.display = 'none';
            document.querySelector('.quiz-wrapper').style.display = 'none';

            console.log(`Attempting to fetch quiz data for quiz: ${quizName}`);

            fetch(`/student/startquiz/api/quiz-data/${quizName}`)
                .then(response => {
                    console.log('Raw response from quiz data API:', response);
                    if (!response.ok) {
                        if (response.status === 401) {
                            window.location.href = '/login';
                            return null;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data) {
                        console.log('Fetched and parsed quiz data:', data);
                        quizDataGlobal = data; // Store data globally
                        console.log('quizDataGlobal after assignment:', quizDataGlobal);
                        console.log('Calling displayQuizContent()...');
                        displayQuizContent(); // Call display function to render UI
                        console.log('displayQuizContent() called.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching quiz data:', error);
                    document.body.innerHTML = `
                        <div style="text-align: center; margin-top: 50px; font-family: sans-serif;">
                            <h1>Error Loading Quiz</h1>
                            <p>${error.message}</p>
                            <p>Please try again or contact support.</p>
                            <a href="/student/dashboard" style="padding: 10px 20px; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: 5px;">Back to Dashboard</a>
                        </div>
                    `;
                });
        });

        // Add toast message function
        function showToast(message, type = 'error') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>